---
phase: 02-backend-data-features
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - backend/app/data/strategy.py
  - backend/app/data/weather.py
  - backend/app/api/circuits.py
autonomous: true
requirements: [DATA-02, DATA-03]
user_setup:
  - service: OpenWeatherMap
    why: "Live weather data for F1 circuits"
    env_vars:
      - name: OPENWEATHERMAP_API_KEY
        source: "OpenWeatherMap account -> API keys (https://home.openweathermap.org/api_keys). Subscribe to 'One Call by Call' for hourly forecast with rain probability."
    dashboard_config: []

must_haves:
  truths:
    - "Pit strategy analysis returns full stint breakdown with tyre compound, lap ranges, degradation curves, and pit window timing for any driver asked about"
    - "Strategy analysis references historical data from last 3 editions of the same circuit and includes safety car probability"
    - "Weather tool returns real air temperature, rain probability, wind speed/direction, track surface temperature, and humidity for F1 venues"
    - "Weather includes hourly forecast timeline for session duration"
    - "Weather data combines with track-specific context (e.g. street circuits drain poorly)"
    - "Circuit GPS coordinates exist for all 2025 calendar circuits"
  artifacts:
    - path: "backend/app/data/strategy.py"
      provides: "Pit strategy analysis engine with stint breakdown and historical context"
      contains: "analyze_pit_strategy"
    - path: "backend/app/data/weather.py"
      provides: "OpenWeatherMap integration with TTL caching and track context"
      contains: "get_weather_for_circuit"
    - path: "backend/app/api/circuits.py"
      provides: "Circuit metadata with GPS lat/lon coordinates for weather lookups"
      contains: "lat"
  key_links:
    - from: "backend/app/data/strategy.py"
      to: "fastf1"
      via: "session.laps DataFrame for stint/compound/tyre data"
      pattern: "session\\.laps"
    - from: "backend/app/data/weather.py"
      to: "backend/app/api/circuits.py"
      via: "GPS coordinates for OpenWeatherMap API calls"
      pattern: "lat.*lon"
    - from: "backend/app/data/weather.py"
      to: "backend/app/config.py"
      via: "import OPENWEATHERMAP_API_KEY and WEATHER_CACHE_TTL"
      pattern: "from app.config import"
---

<objective>
Build the pit strategy analysis engine and live weather module that replace the existing weather stub.

Purpose: DATA-02 requires undercut/overcut analysis with historical stint data, and DATA-03 requires real weather data replacing the current placeholder. Both modules are pure-function computation that will be wrapped as LangChain tools in Plan 03.

Output: `backend/app/data/strategy.py` with `analyze_pit_strategy()`, `backend/app/data/weather.py` with `get_weather_for_circuit()`, and GPS coordinates added to `circuits.py`.
</objective>

<execution_context>
@/Users/adityamurarka/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adityamurarka/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-backend-data-features/02-CONTEXT.md
@.planning/phases/02-backend-data-features/02-RESEARCH.md
@.planning/phases/02-backend-data-features/02-01-SUMMARY.md
@backend/app/api/circuits.py
@backend/app/api/tools.py
@backend/app/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build pit strategy analysis engine</name>
  <files>
    backend/app/data/strategy.py
  </files>
  <action>
Create `backend/app/data/strategy.py` implementing:

1. **`analyze_pit_strategy(year: int, round_num: int, driver_code: str = None) -> dict`** — Main function. If driver_code is provided, returns strategy analysis for that specific driver. If None, returns a circuit-level strategy overview.

2. **Current race stint data** — Load the race session via FastF1 with `laps=True`. Extract stint data from `session.laps` DataFrame using columns: `Driver`, `Stint`, `Compound`, `LapNumber`, `LapTime`, `TyreLife`, `FreshTyre`. Group by `(Driver, Stint, Compound)` to produce stint summaries:
   - Tyre compound per stint (SOFT/MEDIUM/HARD/INTERMEDIATE/WET)
   - Lap range (start lap to end lap of each stint)
   - Stint length (number of laps)
   - Average lap time per stint
   - Degradation curve: compute lap time delta between first 3 laps and last 3 laps of each stint (positive = degrading)
   - Pit window timing: lap number of each pit stop

3. **Historical strategy data** — Load race sessions from last 3 editions of the same circuit (e.g., Monaco 2024, 2023, 2022). For each historical race, extract the same stint summaries. Identify dominant strategies: most common number of stops, most common compound sequence (e.g., M-H, S-M-H). Use the FastF1 location name to identify the circuit across years.

4. **Undercut/overcut analysis** — For driver-specific queries:
   - Compare the driver's stint data to the cars immediately ahead and behind
   - Identify pit windows where an undercut was attempted (pitted 1-3 laps before car ahead) or overcut (pitted 1-3 laps after)
   - Calculate whether the undercut/overcut succeeded (net position gain/loss)

5. **Safety car probability** — From the last 3 editions + last 5 years at the circuit, calculate: `sc_probability = (races_with_safety_car / total_races) * 100`. Include in output as `"safety_car_probability": 65` with context like "Monaco has 65% SC rate -- one-stop gamble is riskier here".

6. **Caching** — In-memory cache keyed by `(year, round_num)` for current race data and `(circuit_key, year)` for historical data. Same pattern as predictions module.

7. **Thread safety** — Use `_fastf1_lock = threading.Lock()` for all FastF1 session loads (same pattern as predictions.py — import from a shared location or define locally).

8. **Return format:**
```python
{
    "year": 2024, "round": 6, "grand_prix": "Monaco Grand Prix",
    "driver": "VER",  # or null for circuit overview
    "stints": [
        {"stint": 1, "compound": "MEDIUM", "laps": "1-25", "stint_length": 25,
         "avg_lap_time": "1:15.432", "degradation_sec": 0.8, "fresh_tyres": True},
        {"stint": 2, "compound": "HARD", "laps": "26-78", "stint_length": 53,
         "avg_lap_time": "1:16.102", "degradation_sec": 1.2, "fresh_tyres": True}
    ],
    "pit_stops": [{"lap": 26, "position_before": 1, "position_after": 1}],
    "historical_strategies": {
        "dominant_strategy": "1-stop Medium-Hard",
        "editions": [
            {"year": 2024, "winner_strategy": "M-H (1 stop)", "avg_stops": 1.2},
            {"year": 2023, "winner_strategy": "M-H (1 stop)", "avg_stops": 1.1}
        ]
    },
    "undercut_overcut": [
        {"type": "undercut", "target_driver": "PER", "lap": 25,
         "result": "gained 1 position"}
    ],
    "safety_car_probability": 65,
    "safety_car_context": "Monaco has had safety cars in 5 of last 8 races"
}
```

9. **Error handling** — If a specific historical year has no data (new circuit), skip it. If driver_code is not found in session, return error dict. Use structlog throughout.
  </action>
  <verify>
    Run: `cd /Users/adityamurarka/Desktop/F1-AI/backend && python -c "from app.data.strategy import analyze_pit_strategy; print('strategy import OK')"`
  </verify>
  <done>
    - `analyze_pit_strategy(year, round_num, driver_code)` is importable
    - Function extracts stint data from FastF1 laps DataFrame (compound, lap ranges, degradation)
    - Historical strategy data loaded from last 3 editions of the circuit
    - Undercut/overcut analysis compares pit timing between drivers
    - Safety car probability calculated from circuit history
    - Thread-safe FastF1 access with lock pattern
  </done>
</task>

<task type="auto">
  <name>Task 2: Build weather module with circuit GPS and caching</name>
  <files>
    backend/app/data/weather.py
    backend/app/api/circuits.py
  </files>
  <action>
**Part A: Add GPS coordinates to circuits.py**

Add `"lat"` and `"lon"` fields to every circuit entry in `CIRCUIT_DATA` dict in `backend/app/api/circuits.py`. Coordinates for all 2025 season circuits:

| Location Key | Lat | Lon |
|---|---|---|
| Sakhir | 26.0325 | 50.5106 |
| Jeddah | 21.6319 | 39.1044 |
| Melbourne | -37.8497 | 144.9680 |
| Suzuka | 34.8431 | 136.5407 |
| Shanghai | 31.3389 | 121.2198 |
| Miami / Miami Gardens | 25.9581 | -80.2389 |
| Imola | 44.3439 | 11.7167 |
| Monte Carlo / Monaco | 43.7347 | 7.4206 |
| Barcelona / Montmeló | 41.5700 | 2.2611 |
| Spielberg | 47.2197 | 14.7647 |
| Silverstone | 52.0786 | -1.0169 |
| Spa-Francorchamps | 50.4372 | 5.9714 |
| Zandvoort | 52.3888 | 4.5409 |
| Monza | 45.6156 | 9.2811 |
| Baku | 40.3725 | 49.8533 |
| Marina Bay / Singapore | 1.2914 | 103.8640 |
| Austin | 30.1328 | -97.6411 |
| Mexico City | 19.4042 | -99.0907 |
| São Paulo / Interlagos | -23.7036 | -46.6997 |
| Las Vegas | 36.1147 | -115.1728 |
| Lusail / Qatar | 25.4900 | 51.4542 |
| Yas Marina / Abu Dhabi | 24.4672 | 54.6031 |

Add coordinates to ALL entries in CIRCUIT_DATA, matching existing keys. If a circuit has a duplicate key (e.g., "Miami" and "Miami Gardens"), add to both.

Also add a helper function:
```python
def get_circuit_gps(location: str) -> tuple[float, float] | None:
    """Return (lat, lon) for a circuit, or None if not found."""
    data = CIRCUIT_DATA.get(location)
    if data and "lat" in data and "lon" in data:
        return (data["lat"], data["lon"])
    return None
```

**Part B: Create weather module**

Create `backend/app/data/weather.py` implementing:

1. **`get_weather_for_circuit(location: str) -> dict`** — Main function. Looks up GPS coords from `circuits.py`, fetches weather from OpenWeatherMap, adds track-specific context.

2. **OpenWeatherMap API call** — Use `httpx.AsyncClient` to call One Call 3.0 API:
   - URL: `https://api.openweathermap.org/data/3.0/onecall`
   - Params: `lat`, `lon`, `appid=OPENWEATHERMAP_API_KEY`, `units=metric`, `exclude=minutely,daily,alerts`
   - Fallback: If One Call 3.0 fails (subscription required), try 2.5 current weather API: `https://api.openweathermap.org/data/2.5/weather` (no hourly forecast, but still provides current conditions)
   - If OPENWEATHERMAP_API_KEY is empty, return a helpful error message instead of crashing

3. **TTL caching** — Cache keyed by circuit location string. Cache entry: `(timestamp, data)`. Check `time.time() - cached_time < WEATHER_CACHE_TTL` (from config.py, default 600s = 10 min). Since the function is async, use a simple dict cache (single-threaded asyncio loop).

4. **Track-specific context** — Based on `circuit_type` from CIRCUIT_DATA, add context:
   - Street circuits: "Street circuits have limited drainage — wet conditions significantly impact grip and increase Safety Car probability"
   - High altitude (Mexico City): "High altitude reduces air density — affects engine performance and aerodynamic downforce"
   - Desert circuits (Sakhir, Lusail, Yas Marina, Jeddah): "Desert circuit — sand on track surface is common, especially early in the weekend. Track evolution is significant."
   - Coastal circuits: "Coastal location — wind direction can change significantly during the session"

5. **Hourly forecast for session duration** — Extract the next 3-4 hours from `hourly[]` array. Map each hour to: `{"time": "14:00", "temp": 28.5, "rain_probability": 0.15, "wind_speed": 12.3, "description": "partly cloudy"}`. Per CONTEXT.md: "Include hourly forecast timeline for session duration".

6. **Return format:**
```python
{
    "location": "Monaco",
    "circuit_name": "Circuit de Monaco",
    "current": {
        "air_temp_c": 22.5,
        "track_temp_c": 38.0,  # estimated from air temp + sun exposure heuristic if not available from API
        "humidity_pct": 65,
        "wind_speed_kph": 12.3,
        "wind_direction": "SW",
        "rain_probability_pct": 15,
        "conditions": "Partly cloudy"
    },
    "hourly_forecast": [
        {"time": "14:00", "temp_c": 23.0, "rain_probability_pct": 15,
         "wind_speed_kph": 11.5, "conditions": "Partly cloudy"},
        ...
    ],
    "track_context": "Street circuit — limited drainage, wet conditions significantly impact grip",
    "strategy_impact": "Low rain probability — standard dry strategy expected"
}
```

7. **`strategy_impact` field** — Per Claude's discretion on dry/wet scenario split:
   - If any hourly `pop >= 0.4`: return "High rain probability — dual dry/wet strategy scenarios recommended"
   - If any hourly `pop >= 0.2`: return "Moderate rain risk — teams may prepare intermediate tyres as backup"
   - Otherwise: return "Low rain probability — standard dry strategy expected"

Use structlog for all logging. Import `OPENWEATHERMAP_API_KEY` and `WEATHER_CACHE_TTL` from `app.config`.
  </action>
  <verify>
    Run: `cd /Users/adityamurarka/Desktop/F1-AI/backend && python -c "from app.data.weather import get_weather_for_circuit; print('weather import OK')"`
    Run: `cd /Users/adityamurarka/Desktop/F1-AI/backend && python -c "from app.api.circuits import get_circuit_gps; coords = get_circuit_gps('Monaco'); print(f'Monaco GPS: {coords}')"`
    Run: `cd /Users/adityamurarka/Desktop/F1-AI/backend && python -c "from app.api.circuits import CIRCUIT_DATA; missing = [k for k,v in CIRCUIT_DATA.items() if 'lat' not in v]; print(f'Circuits missing GPS: {missing}' if missing else 'All circuits have GPS')"`
  </verify>
  <done>
    - `get_weather_for_circuit(location)` is importable and returns dict with current conditions + hourly forecast
    - All circuits in CIRCUIT_DATA have `lat` and `lon` fields
    - `get_circuit_gps(location)` returns (lat, lon) tuple for any circuit
    - Weather data is cached with 10-minute TTL
    - Track-specific context based on circuit_type is included
    - Hourly forecast for next 3-4 hours is included
    - strategy_impact field uses 40% rain threshold for dual scenario recommendation
    - Graceful fallback when API key is missing or API returns error
  </done>
</task>

</tasks>

<verification>
1. `python -c "from app.data.strategy import analyze_pit_strategy"` succeeds
2. `python -c "from app.data.weather import get_weather_for_circuit"` succeeds
3. `python -c "from app.api.circuits import get_circuit_gps; assert get_circuit_gps('Sakhir') is not None"` succeeds
4. All circuits in CIRCUIT_DATA have lat/lon fields
5. Weather module imports OPENWEATHERMAP_API_KEY and WEATHER_CACHE_TTL from config
6. Strategy module uses threading.Lock for FastF1 access
</verification>

<success_criteria>
- Pit strategy returns full stint breakdown (compound, lap ranges, degradation, pit windows) for any driver
- Historical strategy loaded from last 3 editions with dominant strategy identification
- Undercut/overcut analysis compares pit timing between adjacent drivers
- Safety car probability calculated from circuit history
- Weather returns real data from OpenWeatherMap with air temp, rain probability, wind, humidity
- Hourly forecast timeline included for session duration
- Track-specific context adds strategic value to raw weather numbers
- All circuit GPS coordinates populated for 2025 season
</success_criteria>

<output>
After completion, create `.planning/phases/02-backend-data-features/02-02-SUMMARY.md`
</output>
